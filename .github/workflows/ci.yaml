name: CI - Testes Pytest

# O workflow ser치 executado em pushes para 'dev' e 'main', 
# e em Pull Requests (PRs) direcionados a 'dev' e 'main'.
on:
  push:
    branches: [ "dev", "main" ] 
  pull_request:
    branches: [ "dev", "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest # O sistema operacional onde o c칩digo ser치 executado

    # 游뚿 CORRE칂츾O: Define a vari치vel de ambiente para todo o job
    # Isso garante que a URI de teste seja definida antes de qualquer importa칞칚o do Flask/SQLAlchemy
    env:
      # Usa um banco de dados SQLite em mem칩ria para o ambiente de CI
      SQLALCHEMY_DATABASE_URI: "sqlite:///:memory:"

    steps:
    - name: 拘勇 Checkout do C칩digo
      uses: actions/checkout@v4

    - name: 游냀 Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' 

    - name: 游닍 Instalar Depend칡ncias
      run: |
        python -m pip install --upgrade pip
        # Instala todas as depend칡ncias do requirements.txt
        pip install -r requirements.txt
        
        # For칞a o upgrade do pytest-flask e do pytest (para garantir a compatibilidade com Flask 3.x)
        pip install --upgrade pytest-flask pytest pytest-cov

    - name: 游빍 Rodar Testes com Pytest
      run: |
        # A vari치vel SQLALCHEMY_DATABASE_URI j치 est치 definida pelo bloco 'env' acima.
        # Agora, o Pytest consegue importar 'from main import app' sem erro.
        pytest --cov=. --cov-report=term