name: CI - Testes Pytest

# O workflow ser치 executado em pushes para 'dev' e 'main', 
# e em Pull Requests (PRs) direcionados a 'dev' e 'main'.
on:
  push:
    branches: [ "dev", "main" ] 
  pull_request:
    branches: [ "dev", "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest # O sistema operacional onde o c칩digo ser치 executado

    # Removemos o bloco 'env' aqui para evitar conflitos de escopo
    # A vari치vel ser치 injetada explicitamente no passo de instala칞칚o.
    
    steps:
    - name: 拘勇 Checkout do C칩digo
      uses: actions/checkout@v4

    - name: 游냀 Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' 

    - name: 游닍 Instalar Depend칡ncias e Configurar URI de Teste
      run: |
        python -m pip install --upgrade pip
        # 游뚿 CORRE칂츾O: Define a vari치vel de ambiente aqui, garantindo que ela esteja dispon칤vel 
        # antes de qualquer importa칞칚o do Flask/SQLAlchemy
        echo "SQLALCHEMY_DATABASE_URI=sqlite:///:memory:" >> $GITHUB_ENV
        
        # Instala todas as depend칡ncias do requirements.txt
        pip install -r requirements.txt
        
        # For칞a o upgrade do pytest-flask e do pytest (para garantir a compatibilidade com Flask 3.x)
        pip install --upgrade pytest-flask pytest pytest-cov

    - name: 游빍 Rodar Testes com Pytest
      run: |
        # Agora, a vari치vel SQLALCHEMY_DATABASE_URI est치 definida no ambiente ($GITHUB_ENV) 
        # antes que o Pytest comece a coletar os testes.
        pytest --cov=. --cov-report=term
