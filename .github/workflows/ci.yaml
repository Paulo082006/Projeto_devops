name: CI - Testes Pytest

# O workflow ser√° executado em pushes para 'dev' e 'main', 
# e em Pull Requests (PRs) direcionados a 'dev' e 'main'.
on:
  push:
    branches: [ "dev", "main" ] 
  pull_request:
    branches: [ "dev", "main" ]
  workflow_dispatch: # Permite execu√ß√£o manual via interface do GitHub

jobs:
  build-and-test:
    runs-on: ubuntu-latest # O sistema operacional onde o c√≥digo ser√° executado

    steps:
    - name: ‚¨áÔ∏è Checkout do C√≥digo
      uses: actions/checkout@v4 # Baixa seu c√≥digo

    - name: üêç Configurar Python
      uses: actions/setup-python@v5
      with:
        # Usando Python 3.12 conforme suas depend√™ncias
        python-version: '3.12' 

    - name: üì¶ Instalar Depend√™ncias e Corrigir Compatibilidade
      run: |
        python -m pip install --upgrade pip
        # 1. Instala todas as depend√™ncias, incluindo a vers√£o antiga do pytest-flask
        pip install -r requirements.txt
        
        # 2. For√ßa a atualiza√ß√£o do pytest-flask e do pytest para vers√µes compat√≠veis com Flask 3.x
        pip install --upgrade pytest-flask pytest pytest-cov

    - name: üß™ Rodar Testes com Pytest
      run: |
        # Injeta a vari√°vel de ambiente necess√°ria ANTES da execu√ß√£o do pytest.
        # Isso satisfaz o requisito de 'SQLALCHEMY_DATABASE_URI' quando o Flask √© inicializado no main.py.
        # Estamos usando a URI em mem√≥ria para n√£o depender de um banco de dados real no CI.
        export SQLALCHEMY_DATABASE_URI="sqlite:///:memory:"
        
        # Executa o pytest. O --cov gera o relat√≥rio de cobertura.
        pytest --cov=. --cov-report=term
